# 取消翻译功能说明

## 功能概述 ✨

现在PDF翻译工具支持**实时取消**正在进行的翻译任务！

## 使用方法

### 界面变化

翻译开始后，按钮区域会显示两个按钮：

```
┌─────────────────────┬─────────┐
│   翻译中...         │  ❌ 取消翻译  │
│   [ spinner ]       │         │
└─────────────────────┴─────────┘
```

### 操作步骤

1. **开始翻译**
   - 点击"开始翻译"按钮
   - 翻译开始后，右侧会显示红色的"取消翻译"按钮

2. **取消翻译**
   - 点击"取消翻译"按钮
   - 系统会立即发送取消请求
   - 翻译任务会在下一个检查点停止
   - 日志窗口显示"翻译已取消"

3. **状态重置**
   - 按钮恢复为"开始翻译"
   - 可以重新上传文件开始新的翻译

## 取消机制

### 后端实现

1. **取消标志**
   - 每个任务有独立的取消标志
   - 取消请求会设置标志为`True`

2. **检查点**
   - 每页翻译前检查
   - 每个文本块翻译前检查
   - 确保及时响应取消操作

3. **优雅退出**
   - 清理临时文件
   - 释放资源
   - 发送取消状态到前端

### 前端实现

1. **按钮切换**
   - 翻译中：显示取消按钮
   - 完成/取消：隐藏取消按钮

2. **状态管理**
   - 跟踪当前任务ID
   - 管理SSE连接
   - 处理取消响应

3. **用户反馈**
   - 日志窗口显示取消过程
   - 状态消息提示

## 响应时间

### 实时响应

取消操作会在以下时刻生效：

- ✅ **最快** - 当前文本块翻译完成前
- ⏱️ **平均** - 1-2秒内（当前页翻译完成后）
- ⚠️ **最慢** - 当前页所有文本块处理完

### 示例

```
用户点击取消
    ↓
后端收到取消请求
    ↓
设置取消标志
    ↓
当前文本块翻译完成
    ↓
检查到取消标志
    ↓
停止翻译，清理资源
    ↓
返回取消状态
    ↓
前端显示"翻译已取消"
```

## 日志示例

### 正常取消流程

```
[16:20:15] 开始翻译PDF文件，共 10 页
[16:20:15] 正在翻译第 1/10 页...

[文本块 1] 原文:
This is the first text block...

[16:20:18] 正在取消翻译...
[16:20:18] 翻译已取消
```

### 翻译中途取消

```
========== 第 3/10 页 ==========

[文本块 2] 原文:
Some text here...

[16:20:25] 正在取消翻译...
[16:20:25] 翻译已取消

输入tokens: 1,234
输出tokens: 1,156
已用费用: $0.0000 USD
```

## 技术细节

### 后端API

**POST `/cancel/<task_id>`**
- 设置任务的取消标志
- 返回取消确认

### 取消检查

```python
def _check_cancelled(self):
    """检查是否需要取消翻译"""
    if self.cancel_callback:
        self.cancel_callback()
```

在以下位置调用：
- 每页开始前
- 每个文本块翻译前

### 状态码

| 状态 | 说明 |
|------|------|
| `processing` | 正在处理 |
| `completed` | 翻译完成 |
| `cancelled` | 用户取消 |
| `error` | 翻译错误 |

## 用户体验

### 视觉反馈

1. **按钮状态**
   - 翻译中：显示加载动画 + "翻译中..."
   - 取消按钮：红色渐变 + X图标

2. **日志提示**
   - "正在取消翻译..."（蓝色）
   - "翻译已取消"（绿色）

3. **状态消息**
   - 顶部显示"翻译已取消"

### 性能考虑

- 取消操作不会阻塞其他任务
- 每个任务独立的取消标志
- 自动清理资源

## 注意事项

### ⚠️ 重要提示

1. **时机很重要**
   - 在当前文本块翻译完成后才会真正停止
   - 不会中断正在进行的API请求

2. **已处理的部分**
   - 已经翻译的页面不会被保存
   - 临时文件会被自动清理

3. **重新开始**
   - 取消后可以立即开始新的翻译
   - 需要重新上传文件

## 与其他功能的集成

### Token统计
- 取消时显示已消耗的tokens
- 费用估算截止到取消时刻

### 日志系统
- 记录取消操作
- 显示翻译进度

### 文件管理
- 自动清理临时文件
- 不产生部分翻译的PDF

## 常见问题

### Q: 为什么点击取消后还在翻译？
A: 取消会在下一个检查点生效（每页或每个文本块），通常1-2秒内。

### Q: 取消后已经翻译的内容会保存吗？
A: 不会。取消会清理所有临时文件，需要重新开始翻译。

### Q: 可以取消后继续翻译吗？
A: 不支持断点续传。取消后需要从头开始重新翻译。

### Q: 取消需要额外费用吗？
A: 不需要。只会收取已经完成翻译部分的费用。

## 更新日志

### v2.2.0 (最新)
- ✨ 新增取消翻译功能
- ✨ 实时取消按钮
- 🎨 优化按钮布局
- 📝 完善取消日志

### v2.1.0
- Token统计和费用估算
- 详细翻译日志

### v2.0.0
- 多API支持
- 实时进度显示
