# PDF翻译工具 - 新功能说明

## 新增功能 ✨

### 1. Token统计和费用估算 📊

现在翻译过程中会实时显示：
- **输入Tokens** - 原文本的token数量
- **输出Tokens** - 翻译后文本的token数量
- **预估费用** - 根据API定价估算的费用（美元）

#### API定价参考

| API服务 | 输入价格 | 输出价格 |
|---------|---------|---------|
| Google Translate | 免费 | 免费 |
| DeepSeek | $0.14/M tokens | $0.28/M tokens |
| 智谱AI GLM-4-Flash | ~$0.5/M tokens | ~$0.5/M tokens |

### 2. 详细翻译日志 📝

翻译日志窗口现在显示：

#### 页面级别日志
- 每页的分隔标记
- `========== 第 X/Y 页 ==========`

#### 文本块级别日志
- **原文显示** - 蓝色背景，左侧蓝色边框
  ```
  [文本块 1] 原文:
  This is the original text extracted from PDF...
  ```

- **译文显示** - 绿色背景，左侧绿色边框
  ```
  [文本块 1] 译文:
  这是从PDF提取的原始文本的翻译...
  ```

#### 最终统计
翻译完成后会显示：
```
========== 翻译完成 ==========
输入tokens: 12,345
输出tokens: 11,234
预估费用: $0.0048 USD
```

### 3. 实时Token追踪 🔄

每个文本块翻译时：
1. 自动估算原文的token数量
2. 翻译完成后估算译文的token数量
3. 累加到总token数
4. 实时更新费用显示

### 4. 日志格式化美化 🎨

#### 日志类型
- **info** (蓝色) - 一般信息
- **success** (绿色) - 成功/完成信息
- **error** (红色) - 错误信息

#### 特殊格式
- 页面分隔标记使用紫色粗体
- 原文使用蓝色背景块
- 译文使用绿色背景块

## 使用说明

### 界面布局

```
┌─────────────────────────────────────┐
│  翻译进度                     45%   │
│  ████████████████░░░░░░░░░░░░░░░░░   │
│  正在翻译第 5/10 页...               │
│                                      │
│  输入Tokens  输出Tokens  预估费用    │
│    5,234       4,890     $0.0023    │
│                                      │
│  ┌─ 翻译日志（原文/译文）─────────┐ │
│  │ [16:20:15] 开始翻译PDF文件...  │ │
│  │ ============================== │ │
│  │ ========== 第 1/10 页 ======== │ │
│  │                             │ │
│  │ [文本块 1] 原文:            │ │
│  │ ┌─────────────────────────┐ │ │
│  │ │ This is a PDF document...│ │ │
│  │ └─────────────────────────┘ │ │
│  │                             │ │
│  │ [文本块 1] 译文:            │ │
│  │ ┌─────────────────────────┐ │ │
│  │ │ 这是一个PDF文档...       │ │ │
│  │ └─────────────────────────┘ │ │
│  │                             │ │
│  └─────────────────────────────┘ │
└─────────────────────────────────────┘
```

### 测试建议

1. **使用小文件测试** - 先用几页的PDF测试功能
2. **选择Google API** - 免费且稳定
3. **观察日志** - 查看原文和译文的提取和翻译过程
4. **检查费用** - 估算费用是否合理

## Token估算说明

### 估算方法

- **中文文本** - 约1字符 = 1 token
- **英文文本** - 约4字符 = 1 token
- **其他语言** - 根据字符密度估算

### 注意事项

⚠️ 这是粗略估计，实际token数可能有所不同：
- API的实际token计算可能更复杂
- 特殊字符、格式等会影响token数
- 费用仅供参考，以实际API账单为准

## 性能优化

### 日志限制
- 最多保存500条日志记录
- 自动清理旧日志，防止内存溢出

### 文本截断
- 日志中显示的文本截断为100字符
- 实际翻译使用完整文本

## 常见问题

### Q: 为什么Google Translate显示费用为$0？
A: Google Translate API目前是免费的，所以费用估算为0。

### Q: Token数量准确吗？
A: 这是基于字符数的粗略估算。实际API使用的token数可能略有不同。

### Q: 日志显示的文本是完整的吗？
A: 为了避免日志过长，显示的文本会被截断为100字符，但翻译使用的是完整文本。

### Q: 如何降低费用？
A:
1. 使用Google Translate（免费）
2. 压缩PDF文件大小
3. 选择更经济的API（如DeepSeek）

## 技术实现

### 后端
- `translator.py` - Token估算和费用计算
- `app.py` - 日志回调处理

### 前端
- 实时SSE连接接收日志
- 格式化显示原文和译文
- 动态更新token统计

## 更新日志

### v2.1.0 (最新)
- ✨ 新增token统计和费用估算
- ✨ 新增详细的翻译日志（原文/译文显示）
- 🎨 优化日志显示格式
- 🐛 修复已知问题

### v2.0.0
- ✨ 多API支持（Google/DeepSeek/智谱AI）
- ✨ 实时进度显示
- ✨ 翻译日志窗口

### v1.0.0
- 🎉 初始版本
