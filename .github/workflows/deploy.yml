name: Build & Deploy PDF Translator

on:
  push:
    branches: ["main"]
  workflow_dispatch:

env:
  IMAGE_NAME: ${{ secrets.DOCKER_USERNAME }}/pdf-translator

jobs:
  # ── 1. 测试 ────────────────────────────────────────────────────────────────
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: pip install flask pymupdf werkzeug requests deep-translator gunicorn

      - name: Syntax check
        run: |
          python -m py_compile translator.py app.py
          echo "✓ Syntax check passed"

      - name: Unit tests
        run: |
          python -c "
          from translator import PDFTranslator
          import inspect

          t = PDFTranslator(api_type='google')
          assert hasattr(t, '_translation_cache'), 'Missing _translation_cache'
          print('✓ PDFTranslator instantiation OK')

          blocks = [
              {'page_num': 0, 'block_idx': i, 'text': 'x' * n, 'rect': None}
              for i, n in enumerate([50, 60, 70, 200, 40, 30])
          ]
          groups = t._group_short_blocks(blocks)
          assert len(groups) > 0, 'No groups returned'
          single_groups = [g for gtype, g in groups if gtype == 'single']
          assert any(b['text'] == 'x' * 200 for g in single_groups for b in g), \
              'Long block should be single'
          print(f'✓ _group_short_blocks: {len(blocks)} blocks -> {len(groups)} groups')

          print('=== All tests passed ✓ ===')
          "

  # ── 2. 构建并推送 Docker 镜像 ──────────────────────────────────────────────
  build:
    name: Build & Push Image
    runs-on: ubuntu-latest
    needs: test
    outputs:
      image_tag: ${{ steps.meta.outputs.tags }}
      image_digest: ${{ steps.push.outputs.digest }}

    steps:
      - uses: actions/checkout@v4

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_NAME }}
          tags: |
            type=sha,prefix=,format=short
            type=raw,value=latest

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push
        id: push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Summary
        run: |
          echo "### Docker Image Built ✓" >> $GITHUB_STEP_SUMMARY
          echo "- Image: \`${{ env.IMAGE_NAME }}:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "- Digest: \`${{ steps.push.outputs.digest }}\`" >> $GITHUB_STEP_SUMMARY

  # ── 3. SSH 部署到远程服务器 ─────────────────────────────────────────────────
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: production
      url: http://${{ secrets.DEPLOY_HOST }}:5001

    steps:
      - uses: actions/checkout@v4

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_KEY }}
          port: ${{ secrets.DEPLOY_PORT || 22 }}
          script: |
            set -e

            # 创建部署目录
            mkdir -p ~/pdf-translator
            cd ~/pdf-translator

            # 拉取最新的 docker-compose.yml
            cat > docker-compose.yml << 'EOF'
            services:
              pdf-translator:
                image: ${{ secrets.DOCKER_USERNAME }}/pdf-translator:latest
                container_name: pdf-translator
                restart: unless-stopped
                ports:
                  - "5001:5001"
                environment:
                  - PYTHONUNBUFFERED=1
                tmpfs:
                  - /tmp
                healthcheck:
                  test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:5001/')"]
                  interval: 30s
                  timeout: 10s
                  retries: 3
                  start_period: 15s
            EOF

            # 拉取新镜像并重启容器
            docker compose pull
            docker compose up -d --remove-orphans

            # 等待健康检查通过
            echo "Waiting for service to be healthy..."
            for i in $(seq 1 12); do
              STATUS=$(docker inspect --format='{{.State.Health.Status}}' pdf-translator 2>/dev/null || echo "starting")
              echo "  [$i/12] Status: $STATUS"
              if [ "$STATUS" = "healthy" ]; then
                echo "✓ Service is healthy"
                break
              fi
              sleep 5
            done

            # 清理旧镜像
            docker image prune -f

            echo "✓ Deployment complete"
