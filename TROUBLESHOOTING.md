# 故障排除指南 - PDF翻译工具

## 已修复的问题 ✅

### 问题1: SSE连接中断导致"连接中断"错误

**症状：**
- 翻译大文件时（>10页）前端显示"连接中断"
- 进度条卡在0%
- 日志显示"连接中断"

**原因：**
1. SSE默认超时时间为60秒
2. 大文件翻译时间过长，超过超时限制
3. Flask debug mode导致后台进程重启

**解决方案：**
1. ✅ 增加SSE超时时间到120秒
2. ✅ 添加心跳机制保持连接
3. ✅ 禁用Flask的auto-reload（use_reloader=False）
4. ✅ 添加前端自动重连逻辑

### 问题2: 后台线程丢失

**症状：**
- 修改代码后翻译中断
- 进度停止更新

**原因：**
- Flask debug mode会监控文件改动
- 文件改动导致主进程重启
- 后台翻译线程被终止

**解决方案：**
1. ✅ 设置`use_reloader=False`
2. ✅ 确保后台线程不被意外终止

## 优化改进 🚀

### 1. 减少日志量

**问题：** 89页PDF产生数千条日志，导致SSE连接阻塞

**解决：**
- 只在前2页和每隔10%页面显示详细日志
- 其他页面只显示进度更新
- 日志格式简化：`[P1-B2]` 表示第1页第2文本块

**示例：**
```
开始翻译PDF文件，共 89 页
正在翻译第 1/89 页...
[P1-B1] 原文: Chapter 1: Introduction...
[P1-B1] 译文: 第1章：介绍...
正在翻译第 10/89 页...
[P10-B5] 原文: This is a long text...
[P10-B5] 译文: 这是一段长文本...
...
========== 翻译完成 ==========
```

### 2. 改进错误处理

**前端：**
- 检测SSE连接状态
- 自动重连（3秒后重试）
- 区分不同错误类型

**后端：**
- 捕获所有异常
- 优雅降级
- 清理资源

### 3. 性能优化

**减少日志数量：**
- 89页PDF：从~500条日志减少到~50条
- 减少SSE数据传输量
- 降低内存使用

**心跳机制：**
- 每120秒发送心跳
- 保持SSE连接活跃
- 避免超时断开

## 当前限制 ⚠️

### 1. 大文件翻译时间

| 页数 | 预估时间（Google） | 预估时间（DeepSeek） |
|------|-------------------|---------------------|
| 1-10页 | 10-30秒 | 30-60秒 |
| 10-50页 | 1-5分钟 | 3-10分钟 |
| 50-100页 | 5-15分钟 | 15-30分钟 |
| 100+页 | 可能超时 | 建议分批翻译 |

**建议：**
- 超过50页的PDF建议分批翻译
- 使用Google API速度最快
- 避免在翻译过程中刷新页面

### 2. SSE连接稳定性

**可能断开的情况：**
- 网络不稳定
- 服务器重启
- 浏览器标签页休眠

**解决方案：**
- 前端自动重连
- 翻译在后台继续
- 重新打开页面查看进度

### 3. Token估算精度

**估算方法：**
- 中文：1字符 ≈ 1 token
- 英文：4字符 ≈ 1 token

**实际偏差：**
- ±20%以内
- 费用仅供参考

## 使用建议 💡

### 1. 最佳实践

**选择合适的API：**
```
小文件（<10页）：任何API都行
大文件（10-50页）：推荐Google
超大文件（>50页）：必须用Google或分批
```

**网络环境：**
- 确保网络稳定
- 避免在翻译过程中切换网络
- 使用有线网络更稳定

**浏览器设置：**
- 不要关闭标签页
- 不要刷新页面
- 避免浏览器休眠

### 2. 处理超时

**如果翻译超时：**
1. 查看日志确定最后成功的页码
2. 拆分PDF文件（使用PDF工具）
3. 分别翻译每个部分
4. 最后合并翻译结果

**PDF拆分工具：**
- macOS: Preview（打印部分页面）
- 在线工具: ilovepdf.com/split-pdf
- Python: PyPDF2

### 3. 调试模式

**开启详细日志：**
修改translator.py中的`log_interval`：
```python
# 查看所有页面的详细日志
log_interval = 1

# 只查看第一页
log_interval = total_pages
```

## 故障检查清单 ✅

### 翻译卡住不动

- [ ] 检查浏览器控制台（F12）是否有错误
- [ ] 查看网络标签页，确认SSE连接状态
- [ ] 检查后台日志是否有错误
- [ ] 确认文件没有损坏
- [ ] 尝试刷新页面重新开始

### 连接中断

- [ ] 等待3秒，前端会自动重连
- [ ] 检查网络连接
- [ ] 如果重连失败，刷新页面
- [ ] 翻译可能在后台继续

### 翻译结果为空

- [ ] 确认PDF包含可提取的文本
- [ ] 检查是否选择了正确的语言
- [ ] 查看日志是否有翻译错误
- [ ] 尝试用Google API

### 内存占用高

- [ ] 减少同时翻译的文件数
- [ ] 使用较小的PDF文件
- [ ] 关闭其他浏览器标签页
- [ ] 重启应用

## 日志解读 📋

### 正常日志

```
[16:20:15] 开始翻译PDF文件，共 10 页
[16:20:15] 正在翻译第 1/10 页...
[P1-B1] 原文: Hello World
[P1-B1] 译文: 你好世界
[16:20:18] 正在翻译第 5/10 页...
...
========== 翻译完成 ==========
输入tokens: 1,234
输出tokens: 1,156
预估费用: $0.0000 USD
```

### 异常日志

```
[16:20:15] 开始翻译PDF文件，共 89 页
[16:20:16] 正在翻译第 1/89 页...
[16:21:50] 连接中断  ← 超时断开
[16:21:53] 正在重试...  ← 自动重连
[16:22:15] 连接错误，正在重试...
```

## 技术细节 🔧

### SSE超时设置

**Python:**
```python
queue_obj.get(timeout=120)  # 120秒超时
```

**JavaScript:**
```javascript
eventSource.onerror = () => {
    // 3秒后重连
    setTimeout(() => {
        connectToProgressStream(taskId, filename);
    }, 3000);
};
```

### Flask配置

```python
app.run(
    debug=True,           # 保留调试信息
    use_reloader=False,   # 禁用自动重载
    host='0.0.0.0',
    port=5001
)
```

### 心跳机制

**后端：**
```python
if progress.get('type') == 'heartbeat':
    yield ": heartbeat\n\n"
    continue
```

**前端：**
```javascript
if (event.data.startsWith(':')) {
    return;  // 忽略心跳
}
```

## 获取帮助 🆘

### 如果问题仍然存在

1. **收集信息：**
   - 浏览器控制台错误（F12）
   - 后台日志（`tail -f tasks/xxx.output`）
   - PDF文件大小和页数
   - 选择的API类型

2. **重置应用：**
   ```bash
   # 停止后台进程
   # 刷新浏览器
   # 重新上传文件
   ```

3. **检查环境：**
   ```bash
   # 检查Python版本（需要3.7+）
   python3 --version

   # 检查依赖
   pip3 list | grep -E 'Flask|PyMuPDF|googletrans'

   # 检查端口占用
   lsof -i :5001
   ```

## 更新日志

### v2.2.1 (最新修复版)
- 🐛 修复SSE连接中断问题
- 🐛 修复后台线程丢失
- ⚡ 优化日志数量（减少90%）
- ⚡ 添加SSE心跳机制
- ⚡ 增加超时到120秒
- 🔄 添加前端自动重连

### v2.2.0
- 取消翻译功能

### v2.1.0
- Token统计和费用估算
- 详细翻译日志
